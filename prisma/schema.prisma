generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String           @id @default(cuid())
  email         String           @unique
  passwordHash  String
  name          String
  phone         String?
  role          UserRole
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  approvals     Approval[]
  auditLogs     AuditLog[]
  briefs        Brief[]          @relation("CreatedBy")
  notifications Notification[]
  assignedTasks ProductionTask[] @relation("AssignedTo")
  clubs         UserClub[]
  salesFocuses  SalesFocus[]     @relation("FocusCreatedBy")
  strategyDocuments StrategyDocument[] @relation("StrategyCreatedBy")
  clubContextUpdates Club[]      @relation("ClubContextUpdatedBy")
}

model Region {
  id           String       @id @default(cuid())
  name         String
  code         String       @unique
  createdAt    DateTime     @default(now())
  clubs        Club[]
  salesFocuses SalesFocus[]
  strategyDocuments StrategyDocument[]
}

model Brand {
  id            String            @id @default(cuid())
  name          String
  code          String            @unique
  guidelinesUrl String?
  logoUrl       String?
  primaryColor  String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  briefs        Brief[]
  clubs         Club[]
  templates     RequestTemplate[]
  salesFocuses  SalesFocus[]
  strategyDocuments StrategyDocument[]
}

model Club {
  id        String     @id @default(cuid())
  name      String
  code      String     @unique
  city      String
  address   String?
  latitude  Float?     // GPS latitude for map
  longitude Float?     // GPS longitude for map
  regionId  String
  brandId   String
  tier      ClubTier   @default(STANDARD)
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // ============================================
  // LOCAL CLUB CONTEXT - Static Profile
  // ============================================
  clubCharacter       String?           // enum value: PREMIUM_LIFESTYLE, MASS_MARKET, PERFORMANCE_FOCUSED, COMMUNITY_DRIVEN, FUNCTIONAL_COMPACT, CUSTOM
  customCharacter     String?           @db.VarChar(50)   // max 50 chars for custom character
  keyMemberGroups     Json?             // array of strings, max 3: ["beginners", "custom:Kobiety 30-40"]
  localConstraints    Json?             // array of strings: ["limited_space", "custom:..."]

  // ============================================
  // LOCAL CLUB CONTEXT - Dynamic Context
  // ============================================
  topActivities       Json?             // array of objects: [{name: "Fitness", popularity: "HIGH"}], 1-3 items
  activityReasons     Json?             // object: {selected: ["matches_demographics"], note: "..."}

  // ============================================
  // LOCAL DECISION BRIEF
  // ============================================
  localDecisionBrief  String?           @db.VarChar(400)  // max 400 chars

  // Context metadata
  contextUpdatedAt    DateTime?
  contextUpdatedById  String?
  contextUpdatedBy    User?             @relation("ClubContextUpdatedBy", fields: [contextUpdatedById], references: [id])

  briefs    Brief[]
  brand     Brand      @relation(fields: [brandId], references: [id])
  region    Region     @relation(fields: [regionId], references: [id])
  users     UserClub[]
}

enum ClubTier {
  STANDARD       // Standardowy klub
  VIP            // Top 10% revenue
  FLAGSHIP       // Flagowa lokalizacja
}

model UserClub {
  userId    String
  clubId    String
  isManager Boolean  @default(false)
  createdAt DateTime @default(now())
  club      Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, clubId])
}

model RequestTemplate {
  id             String   @id @default(cuid())
  name           String
  code           String   @unique
  description    String?
  brandId        String?
  requiredFields Json
  defaultSLADays Int      @default(5)
  isActive       Boolean  @default(true)
  // Policy fields
  baseCost       Decimal? @db.Decimal(10, 2)  // Koszt bazowy szablonu
  isInternal     Boolean  @default(false)     // Czy wewnetrzny szablon (auto-approve)
  isBlacklisted  Boolean  @default(false)     // Czy na blackliscie
  blacklistReason String?                     // Powod blacklisty
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  briefs         Brief[]
  brand          Brand?   @relation(fields: [brandId], references: [id])
}

model Brief {
  id              String          @id @default(cuid())
  code            String          @unique
  createdById     String
  clubId          String
  brandId         String
  templateId      String
  status          BriefStatus     @default(DRAFT)
  priority        Priority        @default(MEDIUM)
  title           String

  // ============================================
  // CORE MODULE 1: Decision Layer (MANDATORY for submission)
  // ============================================
  businessObjective BusinessObjective?  // REQUIRED before submission
  decisionContext   DecisionContext?    // REQUIRED before submission
  kpiDescription    String?             // REQUIRED before submission
  kpiTarget         Float?              // REQUIRED before submission

  // Legacy field (backwards compatibility)
  objective       Objective?

  deadline        DateTime
  startDate       DateTime?
  endDate         DateTime?
  context         String
  offerDetails    String?
  legalCopy       String?
  customFields    Json?
  assetLinks      String[]
  wasExecuted     Boolean?
  perceivedResult Int?
  actualKpiValue  Float?
  submittedAt     DateTime?

  // Policy engine fields
  estimatedCost       Decimal?      @db.Decimal(10, 2)
  isCrisisCommunication Boolean     @default(false)
  policyCheckResult   Json?         // Wyniki walidacji policy
  requiresOwnerApproval Boolean     @default(false)
  ownerApprovalReason String?
  escalationType      EscalationType? // EXCEPTION vs ESCALATION
  confidenceLevel     ConfidenceLevel? // Poziom pewnosci co do wplywu

  // ============================================
  // CORE MODULE 3: AI Auditor Results
  // ============================================
  aiAuditResult       Json?           // Wyniki audytu AI (completeness, consistency, feasibility, policy)
  aiAuditedAt         DateTime?       // Kiedy ostatnio przeprowadzono audyt AI

  // Learning Loop - outcome tagging
  outcome             Outcome?        // Wynik po realizacji
  outcomeNote         String?         // Opcjonalna notatka (1 zdanie)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  approvals       Approval[]
  auditLogs       AuditLog[]
  brand           Brand           @relation(fields: [brandId], references: [id])
  club            Club            @relation(fields: [clubId], references: [id])
  createdBy       User            @relation("CreatedBy", fields: [createdById], references: [id])
  template        RequestTemplate @relation(fields: [templateId], references: [id])
  comments        Comment[]
  productionTask  ProductionTask?

  @@index([status])
  @@index([createdById])
  @@index([clubId])
  @@index([deadline])
  @@index([businessObjective])
}

model Approval {
  id          String           @id @default(cuid())
  briefId     String
  validatorId String
  decision    ApprovalDecision
  notes       String?
  createdAt   DateTime         @default(now())
  brief       Brief            @relation(fields: [briefId], references: [id], onDelete: Cascade)
  validator   User             @relation(fields: [validatorId], references: [id])

  @@index([briefId])
}

// ============================================
// CORE MODULE 2: Production as Internal Service
// ============================================

model ProductionTask {
  id           String        @id @default(cuid())
  briefId      String        @unique
  assigneeId   String?
  status       TaskStatus    @default(QUEUED)
  slaDays      Int
  dueDate      DateTime
  notes        String?
  // Capacity-driven fields
  queuePosition   Int?          // Position in the queue
  estimatedHours  Float?        // Estimated production hours
  actualHours     Float?        // Actual hours spent
  slotId          String?       // Reference to capacity slot
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  comments     Comment[]
  deliverables Deliverable[]
  assignee     User?         @relation("AssignedTo", fields: [assigneeId], references: [id])
  brief        Brief         @relation(fields: [briefId], references: [id], onDelete: Cascade)
  slot         ProductionSlot? @relation(fields: [slotId], references: [id])

  @@index([status])
  @@index([dueDate])
  @@index([queuePosition])
}

// Production Capacity Management
model ProductionCapacity {
  id              String   @id @default(cuid())
  name            String   // e.g., "Design Team", "Video Production"
  description     String?
  // Capacity limits
  dailyHours      Float    @default(8)   // Available hours per day
  weeklySlots     Int      @default(10)  // Number of tasks per week
  maxConcurrent   Int      @default(5)   // Max tasks in progress at once
  // SLA configuration
  defaultSLADays  Int      @default(5)
  rushSLADays     Int      @default(2)   // For CRITICAL priority
  // Supported formats
  supportedFormats String[]  // e.g., ["SOCIAL", "PRINT", "EMAIL"]
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  slots           ProductionSlot[]
}

// Time-based production slots
model ProductionSlot {
  id              String   @id @default(cuid())
  capacityId      String
  date            DateTime @db.Date
  availableHours  Float    // Hours available in this slot
  bookedHours     Float    @default(0) // Hours already booked
  isBlocked       Boolean  @default(false) // e.g., holidays
  blockReason     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  capacity        ProductionCapacity @relation(fields: [capacityId], references: [id])
  tasks           ProductionTask[]

  @@unique([capacityId, date])
  @@index([date])
}

model Deliverable {
  id           String         @id @default(cuid())
  taskId       String
  name         String
  type         String
  fileUrl      String
  version      Int            @default(1)
  isApproved   Boolean        @default(false)
  approvedById String?
  changeNotes  String?
  createdAt    DateTime       @default(now())
  task         ProductionTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model Comment {
  id        String          @id @default(cuid())
  content   String
  authorId  String
  briefId   String?
  taskId    String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  brief     Brief?          @relation(fields: [briefId], references: [id], onDelete: Cascade)
  task      ProductionTask? @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([briefId])
  @@index([taskId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  linkUrl   String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  briefId   String?
  action    String
  details   Json?
  ipAddress String?
  createdAt DateTime @default(now())
  brief     Brief?   @relation(fields: [briefId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@index([briefId])
  @@index([createdAt])
}

enum UserRole {
  CLUB_MANAGER
  VALIDATOR
  PRODUCTION
  REGIONAL_DIRECTOR  // Dyrektor Regionalny
  CMO                // Chief Marketing Officer
  ADMIN
}

enum BriefStatus {
  DRAFT
  SUBMITTED
  CHANGES_REQUESTED
  APPROVED
  REJECTED
  CANCELLED
}

enum TaskStatus {
  QUEUED
  IN_PROGRESS
  IN_REVIEW
  NEEDS_CHANGES
  APPROVED
  DELIVERED
  CLOSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Legacy Objective (for backwards compatibility)
enum Objective {
  ACQUISITION
  RETENTION
  ATTENDANCE
  UPSELL
  AWARENESS
  OTHER
}

// ============================================
// CORE MODULE 1: Decision Layer Enums
// ============================================

// Business Objective - REQUIRED for submission
enum BusinessObjective {
  REVENUE_ACQUISITION      // Revenue / Acquisition
  RETENTION_ENGAGEMENT     // Retention / Engagement
  OPERATIONAL_EFFICIENCY   // Operational Efficiency
}

// Decision Context - REQUIRED for submission
enum DecisionContext {
  LOCAL      // Local decision
  REGIONAL   // Regional decision
  CENTRAL    // Central decision
}

enum ApprovalDecision {
  APPROVED
  CHANGES_REQUESTED
  REJECTED
}

// Learning Loop - wynik realizacji
enum Outcome {
  POSITIVE     // Pozytywny rezultat
  NEUTRAL      // Neutralny
  NEGATIVE     // Negatywny
}

// Rozroznienie Exception vs Escalation
enum EscalationType {
  EXCEPTION    // Swiadoma decyzja - lamie zasade, ale strategicznie uzasadnione
  ESCALATION   // Niepewnosc - brak danych, konflikt sygnalow, niejasny ROI
}

// Confidence Level - poziom pewnosci co do wplywu
enum ConfidenceLevel {
  LOW          // Eksperyment, niepewne
  MEDIUM       // Umiarkowana pewnosc
  HIGH         // Pewny ruch, wysokie zaufanie
}

enum FocusPeriod {
  MONTHLY
  QUARTERLY
  YEARLY
}

model SalesFocus {
  id          String      @id @default(cuid())
  title       String
  description String?
  period      FocusPeriod
  startDate   DateTime
  endDate     DateTime
  brandId     String?
  regionId    String?
  createdById String
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  brand       Brand?      @relation(fields: [brandId], references: [id])
  region      Region?     @relation(fields: [regionId], references: [id])
  createdBy   User        @relation("FocusCreatedBy", fields: [createdById], references: [id])

  @@index([brandId])
  @@index([regionId])
  @@index([startDate, endDate])
}

// ============================================
// Strategy Document - dokument strategiczny
// Dostep: ADMIN, REGIONAL_DIRECTOR, CMO
// ============================================

enum StrategyDocumentType {
  BRAND_GUIDELINES      // Wytyczne marki
  COMMUNICATION_STRATEGY // Strategia komunikacji
  QUARTERLY_GOALS       // Cele kwartalne
  ANNUAL_PLAN          // Plan roczny
  POLICY               // Polityka / regulamin
  OTHER                // Inny dokument
}

enum StrategyDocumentScope {
  GLOBAL               // Dla calej organizacji
  BRAND                // Dla konkretnej marki
  REGION               // Dla konkretnego regionu
}

model StrategyDocument {
  id          String               @id @default(cuid())
  title       String
  description String?
  type        StrategyDocumentType
  scope       StrategyDocumentScope @default(GLOBAL)

  // Scope references (optional based on scope)
  brandId     String?
  regionId    String?

  // Document content
  content     String               @db.Text  // Markdown content
  fileUrl     String?              // Optional file attachment URL

  // Validity period
  validFrom   DateTime             @default(now())
  validUntil  DateTime?            // Null = no expiry

  // Metadata
  version     Int                  @default(1)
  isActive    Boolean              @default(true)
  createdById String

  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  // Relations
  brand       Brand?               @relation(fields: [brandId], references: [id])
  region      Region?              @relation(fields: [regionId], references: [id])
  createdBy   User                 @relation("StrategyCreatedBy", fields: [createdById], references: [id])

  @@index([type])
  @@index([scope])
  @@index([brandId])
  @@index([regionId])
  @@index([isActive])
}
